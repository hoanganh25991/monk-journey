<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monk Journey</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000">
    <meta name="description" content="A Diablo Immortal inspired game featuring a monk character">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="images/logo-192.png">
    <link rel="apple-touch-icon" href="images/logo-192.png">
    <!-- Import Three.js from CDN -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.176.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.176.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="game-container">
        <!-- Game Canvas -->
        <canvas id="game-canvas"></canvas>
    </div>

    <!-- Game UI will be dynamically created by UIManager -->

    <!-- Main script module -->
    <script type="module" src="js/main.js"></script>
    
    <!-- Update Notification -->
    <div id="update-notification" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; text-align: center;">
        <p style="margin: 0 0 10px 0;">New version available!</p>
        <div class="loading-bar" style="height: 5px; width: 100%; background-color: #333; border-radius: 2px; overflow: hidden;">
            <div id="loading-progress" style="height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s;"></div>
        </div>
        <p id="update-status" style="margin: 10px 0 0 0; font-size: 0.9em;">Updating...</p>
    </div>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            // Show update notification
            function showUpdateNotification() {
                document.getElementById('update-notification').style.display = 'block';
            }
            
            // Hide update notification
            function hideUpdateNotification() {
                document.getElementById('update-notification').style.display = 'none';
            }
            
            // Update loading progress
            function updateLoadingProgress(percent, status) {
                document.getElementById('loading-progress').style.width = percent + '%';
                if (status) {
                    document.getElementById('update-status').textContent = status;
                }
            }

            window.addEventListener('load', () => {
                let refreshing = false;
                
                // Handle service worker updates
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        window.location.reload();
                    }
                });
                
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            
                            // Show update notification
                            showUpdateNotification();
                            
                            newWorker.addEventListener('statechange', () => {
                                // Update based on the new service worker's state
                                switch (newWorker.state) {
                                    case 'installing':
                                        updateLoadingProgress(25, 'Installing update...');
                                        break;
                                    case 'installed':
                                        updateLoadingProgress(75, 'Update installed, reloading...');
                                        // If there's a controller, it means the page is being controlled by an old SW
                                        if (navigator.serviceWorker.controller) {
                                            // New content is available, reload to activate the new service worker
                                            setTimeout(() => {
                                                updateLoadingProgress(100, 'Reloading...');
                                                window.location.reload();
                                            }, 1000);
                                        } else {
                                            // First time install, no need to reload
                                            updateLoadingProgress(100, 'Ready!');
                                            setTimeout(hideUpdateNotification, 1000);
                                        }
                                        break;
                                    case 'activating':
                                        updateLoadingProgress(85, 'Activating...');
                                        break;
                                    case 'activated':
                                        updateLoadingProgress(100, 'Complete!');
                                        setTimeout(hideUpdateNotification, 1000);
                                        break;
                                    case 'redundant':
                                        updateLoadingProgress(0, 'Update failed!');
                                        setTimeout(hideUpdateNotification, 3000);
                                        break;
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>